{% extends 'layout.html' %}
{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div>
            <div class="flex items-center gap-4 mb-6">
                <div class="bg-indigo-500/20 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.24-.438.613-.43.992a6.759 6.759 0 0 1 0 1.985c.007.379.137.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.6 6.6 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.063-.374-.313-.686-.645-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.075-.124l-1.217.456a1.125 1.125 0 0 1-1.37-.49l-1.296-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.759 6.759 0 0 1 0-1.985c-.007-.379-.137-.75-.43-.991l-1.004-.827a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.49l1.217.456c.355.133.75.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg></div>
                <div><h1 class="text-2xl font-bold text-white">Manage Categories</h1><p class="text-sm text-gray-400">Add or remove expense categories.</p></div>
            </div>
            <div class="bg-gray-800 p-6 rounded-xl shadow-md mb-6">
                <h2 class="text-lg font-semibold mb-5 text-white">Add a Category</h2>
                <form method="post" class="space-y-5">
                    <input type="hidden" name="form_type" value="category">
                    <div>
                        <label for="name" class="block text-xs font-medium text-gray-400">CATEGORY NAME</label>
                        <input type="text" id="name" name="name" required class="mt-1 block w-full bg-gray-700 border-transparent rounded-lg shadow-sm text-white px-4 py-3 focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>
                    <div>
                        <label for="budget" class="block text-xs font-medium text-gray-400">MONTHLY BUDGET (OPTIONAL)</label>
                        <input type="number" step="0.01" id="budget" name="budget" class="mt-1 block w-full bg-gray-700 border-transparent rounded-lg shadow-sm text-white px-4 py-3 focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>
                    <div class="flex items-center pt-2">
                        <input type="checkbox" id="is_recurring" name="is_recurring" value="1" class="h-4 w-4 bg-gray-700 border-gray-600 rounded text-indigo-600 focus:ring-indigo-500">
                        <label for="is_recurring" class="ml-3 block text-sm text-gray-300">Is this a recurring monthly expense?</label>
                    </div>
                    <div class="pt-2">
                        <button type="submit" class="w-full py-3 px-4 rounded-lg text-sm font-semibold text-white bg-indigo-600 hover:bg-indigo-700">Add Category</button>
                    </div>
                </form>
            </div>
            <h2 class="text-lg font-semibold mb-4 text-white">Existing Categories</h2>
            <div class="bg-gray-800 rounded-xl shadow-md p-4 space-y-2">
            {% for category in categories %}
                <div class="flex justify-between items-center bg-gray-700 p-3 rounded-lg"><span class="text-white font-medium text-sm">{{ category.name }}</span><form action="{{ url_for('delete_category', id=category.id) }}" method="post"><button type="submit" class="text-sm text-red-500 hover:text-red-400 font-semibold">Delete</button></form></div>
            {% else %}
                <p class="text-center text-gray-400 py-4">No categories created yet.</p>
            {% endfor %}
            </div>
        </div>

        <div>
            <div class="flex items-center gap-4 mb-6">
                 <div class="bg-yellow-500/20 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-400" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg></div>
                <div>
                    <h1 class="text-2xl font-bold text-white">Manage Goals</h1>
                    <p class="text-sm text-gray-400">Set targets and drag to prioritize.</p>
                </div>
            </div>
            <div class="bg-gray-800 p-6 rounded-xl shadow-md mb-6">
                <h2 class="text-lg font-semibold mb-5 text-white">Add a Goal</h2>
                <form method="post" enctype="multipart/form-data" class="space-y-5">
                    <input type="hidden" name="form_type" value="goal">
                    <div>
                        <label for="goal_name" class="block text-xs font-medium text-gray-400">GOAL NAME</label>
                        <input type="text" id="goal_name" name="name" required class="mt-1 block w-full bg-gray-700 rounded-lg px-4 py-3">
                    </div>
                    <div>
                        <label for="target_amount" class="block text-xs font-medium text-gray-400">TARGET AMOUNT</label>
                        <input type="number" step="0.01" id="target_amount" name="target_amount" required class="mt-1 block w-full bg-gray-700 rounded-lg px-4 py-3">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-400">TYPE</label>
                        <div class="flex items-center space-x-6 mt-2"><label class="flex items-center"><input type="radio" class="form-radio h-4 w-4 bg-gray-700 text-indigo-500" name="need_want" value="need" required><span class="ml-2 text-sm">Need</span></label><label class="flex items-center"><input type="radio" class="form-radio h-4 w-4 bg-gray-700 text-indigo-500" name="need_want" value="want"><span class="ml-2 text-sm">Want</span></label></div>
                    </div>
                    <div class="flex items-center pt-2">
                        <input type="checkbox" id="show_on_dashboard" name="show_on_dashboard" value="1" class="h-4 w-4 bg-gray-700 rounded text-indigo-600">
                        <label for="show_on_dashboard" class="ml-3 block text-sm text-gray-300">Show this goal on the dashboard</label>
                    </div>
                    <div>
                        <label for="goal_image" class="block text-xs font-medium text-gray-400">GOAL IMAGE (OPTIONAL)</label>
                        <input type="file" id="goal_image" name="goal_image" class="mt-1 block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:font-semibold file:bg-indigo-600 file:text-white hover:file:bg-indigo-700 cursor-pointer">
                    </div>
                    <div class="pt-2"><button type="submit" class="w-full py-3 px-4 rounded-lg text-sm font-semibold text-white bg-indigo-600 hover:bg-indigo-700">Set Goal</button></div>
                </form>
            </div>
            <h2 class="text-lg font-semibold mb-4 text-white">Your Active Goals</h2>
            <div id="goals-list" class="space-y-3">
                {% for goal in goals %}
                <div data-id="{{ goal.id }}" class="bg-gray-800 p-4 rounded-xl shadow-md cursor-grab active:cursor-grabbing">
                    <div class="flex items-center gap-4">
                        {% if goal.image_filename %}<img src="{{ url_for('static', filename='../uploads/' + goal.image_filename) }}" alt="{{ goal.name }}" class="w-20 h-20 rounded-lg object-cover">{% endif %}
                        <div class="flex-grow">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="font-semibold text-white">{{ goal.name }}</h3>
                                    <p class="text-sm text-gray-400">₹{{ "%.2f"|format(goal.current_amount) }} of ₹{{ "%.2f"|format(goal.target_amount) }}</p>
                                </div>
                                <form action="{{ url_for('complete_goal', id=goal.id) }}" method="post"><button type="submit" class="text-sm text-green-400 hover:text-green-300 font-semibold">✓ Complete</button></form>
                            </div>
                            {% set progress = (goal.current_amount / goal.target_amount * 100)|round|int if goal.target_amount > 0 else 0 %}
                            <div class="w-full bg-gray-700 rounded-full h-2.5 mt-2"><div class="bg-yellow-400 h-2.5 rounded-full" style="width: {{ progress }}%"></div></div>
                            <div class="flex items-center justify-end mt-3 text-sm">
                                <form action="{{ url_for('update_goal', id=goal.id) }}" method="post">
                                     <input type="hidden" name="toggle_dashboard" value="1">
                                     <button type="submit" class="text-xs {% if goal.show_on_dashboard %}text-green-400{% else %}text-gray-400{% endif %}">
                                         {% if goal.show_on_dashboard %}✓ Shown on Dashboard{% else %}Show on Dashboard{% endif %}
                                     </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <p class="text-center text-gray-400 py-4">You have no active goals. Set one above!</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const goalsList = document.getElementById('goals-list');
    if(goalsList) {
        new Sortable(goalsList, {
            animation: 150,
            ghostClass: 'bg-gray-700',
            onEnd: function (evt) {
                const order = Array.from(evt.target.children).map(child => child.dataset.id);
                fetch("{{ url_for('update_goal_order') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ order: order })
                });
            }
        });
    }
});
</script>
{% endblock %}